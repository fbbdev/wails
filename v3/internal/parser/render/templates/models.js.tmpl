{{$module := .}}
{{- $runtime := $module.Runtime}}
{{- $models := $module.ModelsFile}}
{{- $internal := $module.InternalFile}}
{{- $imports := $module.Imports -}}
// @ts-check
// Cynhyrchwyd y ffeil hon yn awtomatig. PEIDIWCH Ã‚ MODIWL
// This file is automatically generated. DO NOT EDIT

import {Create as $Create} from "{{js $runtime}}";
{{range $imports.External}}
import * as {{jsimport .}} from "{{js .RelPath}}/{{js $models}}";
{{- end}}{{if $imports.External}}
{{end}}
{{- if $imports.Models}}
{{- $typedefs := false}}
import {
    {{- $first := true}}
    {{- range $model, $class := $imports.Models}}
        {{- if $class}}
            {{- if not $first}}, {{end}}{{$first = false}}
            {{- jsid $model}}
        {{- else}}
            {{- $typedefs = true}}
        {{- end}}
    {{- end -}}
} from "./{{js $models}}";
{{- if $typedefs}}
{{range $model, $class := $imports.Models}}{{if not $class}}
/**
 * @typedef {import("./{{js $models}}").{{jsid $model -}} } {{jsid $model}}
 */
{{- end}}{{end}}
{{- end}}
{{end}}
{{- if $imports.Internal}}
{{- $typedefs := false}}
import {
    {{- $first := true}}
    {{- range $model, $class := $imports.Internal}}
        {{- if $class}}
            {{- if not $first}}, {{end}}{{$first = false}}
            {{- jsid $model}}
        {{- else}}
            {{- $typedefs = true}}
        {{- end}}
    {{- end -}}
} from "./{{js $internal}}";
{{- if $typedefs}}
{{range $model, $class := $imports.Internal}}{{if not $class}}
/**
 * @typedef {import("./{{js $internal}}").{{jsid $model -}} } {{jsid $model}}
 */
{{- end}}{{end}}
{{- end}}
{{end}}
{{- range $model := .Models}}

{{- $isEnum := $model.Values}}
{{- $isClassAlias := and $model.Type (isclass $model.Type)}}
{{- $isTypeAlias := and $model.Type (not (isclass $model.Type))}}
{{- $isStructAlias := and $model.Fields $model.Alias}}
{{- $isClass := and $model.Fields (not $model.Alias)}}

{{- /* Build type parameter list */}}
{{- $typeParams := ""}}
{{- $typeParamList := ""}}
{{- range $i, $param := $model.TypeParams}}
    {{- if or (eq $param "") (eq $param "_")}}
        {{- $param = (printf "T$$%d" $i)}}
    {{- end}}
    {{- $param = (jsid $param)}}
    {{- if eq $i 0}}
        {{- $typeParams = $param}}
        {{- $typeParamList = (printf "<%s" $param)}}
    {{- else}}
        {{- $typeParams = (printf "%s,%s" $typeParams $param)}}
        {{- $typeParamList = (printf "%s, %s" $typeParamList $param)}}
    {{- end}}
{{- end}}
{{- if $typeParamList}}
    {{- $typeParamList = (printf "%s>" $typeParamList)}}
{{- end}}

{{- if or $typeParams $model.Doc $isEnum $isTypeAlias $isStructAlias}}
/**
{{- if $model.Doc}}
{{- jsdoc $model.Doc.Text ""}}
{{- end}}
{{- if $typeParams}}
 * @template {{$typeParams}}
{{- end}}
{{- if $isEnum}}
 * @readonly
 * @enum { {{- $module.JSType $model.Type -}} }
{{- else if $isTypeAlias}}
 * @typedef { {{- $module.JSType $model.Type -}} } {{jsid $model.Name}}
{{- else if $isStructAlias}}
 * @typedef { { {{- range $i, $group := $model.Fields}}{{range $j, $field := $group}}
 {{- if and (ne $i 0) (eq $j 0)}}
 *{{end}}
 *     "{{js $field.Name}}"{{if $field.Optional}}?{{end}}: {{$module.JSFieldType $field.FieldInfo}},
 * } }{{end}}{{end}} {{jsid $model.Name}}
{{- end}}
 */
{{- end}}
{{- if $isEnum}}
export const {{jsid $model.Name}} = {
    {{- range $i, $group := $model.Values}}{{range $j, $sgroup := $group}}{{range $k, $value := $sgroup}}
    {{- if and (ne $i 0) (ne $j 0) (eq $k 0)}}
{{end}}
    {{- if or (and (eq $j 0) (eq $k 0) $value.Group.Group.Doc) (and (eq $k 0) $value.Group.Doc) $value.Doc}}
    {{- if or (gt $j 0) (gt $k 0)}}
{{end}}
    /**
    {{- if and (eq $j 0) (eq $k 0) $value.Group.Group.Doc}}
    {{- jsdoc $value.Group.Group.Doc.Text "    "}}{{if or (and (eq $k 0) $value.Group.Doc) $value.Doc}}
     *{{end}}
    {{- end}}
    {{- if and (eq $k 0) $value.Group.Doc}}
    {{- jsdoc $value.Group.Doc.Text "    "}}{{if $value.Doc}}
     *{{end}}
    {{- end}}
    {{- if $value.Doc}}
    {{- jsdoc $value.Doc.Text "    "}}
    {{- end}}
     */
    {{- end}}
    {{jsid $value.Name}}: {{jsvalue $value.Value}},
    {{- end}}{{end}}{{end}}
};
{{else if $isClassAlias}}
{{- if and $model.Type.TypeParams (gt $model.Type.TypeParams.Len 0)}}
export const {{jsid $model.Name}} = /** @type {typeof {{$module.JSType $model.Type -}} } */({{$module.JSType $model.Type.Origin}});
{{- else}}
export const {{jsid $model.Name}} = {{$module.JSType $model.Type}};
{{- end}}
{{else if $isClass}}
export class {{jsid $model.Name}} {
    /**
     * Creates a new {{jsid $model.Name}} instance.
     * @param {Partial<{{jsid $model.Name}}{{$typeParamList}}>} [$$source = {}] - The source object to create the {{jsid $model.Name}}.
     */
    constructor($$source = {}) {
    {{- range $group := $model.Fields}}{{range $i, $field := $group}}
        {{- /*
            In JS we need to set all properties explicitly
            because JSDoc has no support for arbitrary property names yet.
            See https://github.com/jsdoc/jsdoc/issues/1468

            For optional fields we make the initialization code unreachable
            and cast the false condition to any to prevent any complaint from Typescript.
        */}}
        if ({{if $field.Optional}}/** @type {any} */(false){{else}}!("{{js $field.Name}}" in $$source){{end}}) {
            /**
            {{- if and (eq $i 0) $field.Group.Doc}}
            {{- jsdoc $field.Group.Doc.Text "            "}}{{if $field.Doc}}
             *{{end}}
            {{- end}}
            {{- if $field.Doc}}
            {{- jsdoc $field.Doc.Text "            "}}
            {{- end}}
             * @member
             * @type { {{- $module.JSFieldType $field.FieldInfo}}{{if .Optional}} | undefined{{end -}} }
             */
            this["{{js $field.Name}}"] = {{$module.JSDefault $field.Type $field.Quoted}};
        }
    {{- end}}{{end}}

        Object.assign(this, $$source);
    }

    /**
     * Creates a new {{jsid $model.Name}} instance from a string or object.
     * Generic types also need creation functions for each type parameter.
    {{- if $typeParams}}
     * @template {{$typeParams}}
    {{- end}}
    {{- range $i, $param := $model.TypeParams}}
        {{- if or (eq $param "") (eq $param "_")}}
            {{- $param = (printf "T$$%d" $i)}}
        {{- end}}
        {{- $param = (jsid $param)}}
     * @param {(any) => {{$param -}} } $$create{{$param}}
    {{- end}}
     * @param {any} [$$source = {}]
     * @returns { {{- jsid $model.Name -}}{{$typeParamList}} }
     */
    static createFrom({{range $i, $param := $model.TypeParams}}
                {{- if or (eq $param "") (eq $param "_")}}
                    {{- $param = (printf "T$$%d" $i)}}
                {{- end}}
                {{- $param = (jsid $param) -}}
                $$create{{$param}}, {{end -}}
            $$source = {}) {
        let $$parsedSource = typeof $$source === 'string' ? JSON.parse($$source) : $$source;
        {{- range $i, $group := $model.Fields}}{{range $j, $field := $group}}
        {{- $create := ($module.JSCreate $field.Type)}}
        {{- if ne $create "$Create.Any"}}
        if ("{{js $field.Name}}" in $$parsedSource) {
            $$parsedSource["{{js $field.Name}}"] = {{$create}}($$parsedSource["{{js $field.Name}}"]);
        }
        {{- end}}
        {{- end}}{{end}}
        return new {{jsid $model.Name}}(/** @type {Partial<{{jsid $model.Name}}{{$typeParamList}}>} */($$parsedSource));
    }
}
{{else}}
{{- /* Rendered as a @typedef */}}
{{end}}
{{- end}}
{{- $postponed := $module.PostponedCreates}}
{{- if $postponed}}
// Internal type creation functions
{{- range $i, $create := $postponed}}
const $$createType{{$i}} = {{$create}};
{{- end}}
{{end -}}
